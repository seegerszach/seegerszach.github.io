<html>
<script src='https://d3js.org/d3.v5.min.js'></script>
<style> circle {fill: green; stroke: black;}
        .inflationCircle {fill: red; stroke: black;}
        [name="tooltip"] {
          position: absolute;
          opacity: 0;
          background-color: gainsboro;
          border: 1px solid #999;
          padding: 6px;
          font-size: 14px;
          pointer-events: none;
          transition: opacity 0.3s;
}</style>
<body onload='init()'>
<div style="position: absolute; top: 400px; left: 750px;">
  <button onclick="showNext()" id="showNext">Click To Show The Next 10 Years Of Gas Data</button>
</div>
<div style="position: absolute; top: 450px; left: 750px;">
  <button onclick="restartVisualization()">Click To Restart Visualization</button>
</div>
<div name="tooltip" opacity=0></div>
<div>
  <svg width="950" height="950"></svg>
</div>
<script>

let svg, data, x, y, tooltip;
let inflationDataVisible = false;

async function init() {
y = d3.scaleLinear().domain([0.01,4.8]).range([650,0]);
x = d3.scaleLinear().domain([1950,2025]).range([0,650]);

data = await d3.csv('https://seegerszach.github.io/GasPrices.csv');
svg = d3.select("svg");
tooltip = d3.select("div[name='tooltip']");

const t = d3.transition()
  .duration(7500)
  .ease(d3.easeLinear);

//svg.append('g')
//.attr('transform', 'translate(80,50)')
//.selectAll('circle')
//.data().enter().append('circle')
//.attr("cx", function(d,i) { return x(+d.Year);})
//.attr("cy", function(d,i) { return y(+d.GasolinePrice);})
//.attr("r", 4);

//const line = d3.line()
//  .x(d => x(+d.Year))
//  .y(d => y(+d.GasolinePrice));

//svg.append('g')
//  .attr('transform', 'translate(80,50)')
//  .append('path')
//  .datum()
//  .attr('fill', 'none')
//  .attr('stroke', 'purple')
//  .attr('stroke-width', 2)
//  .attr('d', line);

svg.append("g")
.attr("transform","translate("+80+","+50+")")
.call(d3.axisLeft(y).tickValues([0.1,0.5,1,3,4.5]).tickFormat(d3.format("$.2f")));

svg.append("g")
.attr("transform","translate("+80+","+700+")")
.call(d3.axisBottom(x).tickValues([1950,1960,1970,1980,1990,2000,2010,2020,2023]).tickFormat(d3.format("d")));

svg.append("text")
  .attr("transform", "translate(30,480) rotate(-90)")
  .text("Gasoline Price ($)");

svg.append("text")
  .attr("transform", "translate(380,740)")
  .text("Year");

svg.append("text")
  .attr("transform", "translate(380,20)")
  .text("Gasoline Prices Since 1950");

}

function InflationAdjusted(previousData,currentData) {

  const inflationLine = d3.line()
  .x(function(d){ return x(+d.Year);})
  .y(function(d){ return y(+d["GasolinePriceAdjustedforInflation(2023$/gallon)"]);});

  const group = svg.append('g')
    .attr('class', 'dataGroup')
    .attr('transform', 'translate(80,50)');

  group.selectAll('circle')
    .data(previousData)
    .enter()
    .append('circle')
    .attr('cx', function(d){ return x(+d.Year);})
    .attr('cy', function(d){ return y(+d["GasolinePriceAdjustedforInflation(2023$/gallon)"]);})
    .attr('r', 4)
    .style('fill', 'red')
    .style('opacity', 0.2);

  group.append('path')
    .datum(previousData)
    .attr('fill', 'none')
    .attr('stroke', 'red')
    .attr('stroke-width', 2)
    .attr('d', d3.line()
      .x(function(d){ return x(+d.Year);})
      .y(function(d){ return y(+d["GasolinePriceAdjustedforInflation(2023$/gallon)"]);}))
    .style('opacity', 0.2);

  group.selectAll('.current')
    .data(currentData)
    .enter()
    .append('circle')
    .attr('class', 'current')
    .attr('cx', function(d){ return x(+d.Year);})
    .attr('cy', function(d){ return y(+d["GasolinePriceAdjustedforInflation(2023$/gallon)"]);})
    .attr('r', 4)
    .style('fill', 'red')
    .style('opacity', 1)
    ;

  group.append('path')
    .datum(currentData)
    .attr('fill', 'none')
    .attr('stroke', 'red')
    .attr('stroke-width', 2)
    .attr('d', d3.line()
      .x(function(d){ return x(+d.Year);})
      .y(function(d){ return y(+d["GasolinePriceAdjustedforInflation(2023$/gallon)"]);}))

  // Tool tip/hit area logic
  group.selectAll(".hitarea")
   .data(currentData)
   .enter()
   .append("circle")
   .attr("class", "hitarea")
   .attr('cx', function(d){ return x(+d.Year);})
   .attr('cy', function(d){ return y(+d["GasolinePriceAdjustedforInflation(2023$/gallon)"]);})
   .attr('r', 6)
   .style('fill', 'transparent')
   .style("stroke", "transparent")
   .style('pointer-events', 'all')
   .on("mouseover", function(d,i){tooltip.style("opacity", 1)
      .style("left",(d3.event.pageX + 10)+"px")
      .style("top",(d3.event.pageY + 10)+"px")
      .html("Year: "+d.Year+"<br>Price: "+d["GasolinePriceAdjustedforInflation(2023$/gallon)"]);
      console.log("Hovered:", d.Year);
      d3.select(this)
      .style('fill', 'yellow')
      .style('stroke', 'black')
   })
   .on("mouseout", function() {
    tooltip.style("opacity", 0);
    d3.select(this)
    .style('fill', 'transparent')
    .style('stroke', 'transparent')
   });

   // Legend
   const legend = svg.append("g")
        .attr('class', 'inflationGroup')
        .attr("transform", "translate(750,300)");
        
        legend.append("circle")
        .attr("cx", 0)
        .attr("cy", 0)
        .attr("r", 6)
        .style("fill", "red");

        legend.append("text")
        .attr("x", 15)
        .attr("y", 2)
        .text("Inflation-Adjusted Price")
        .style("font-family", "Arial")
        .style("font-size", "14px")
        .attr("alignment-baseline", "middle");
}

function ActualGasPrices(previousData,currentData)
{
  const group = svg.append('g')
    .attr('class', 'dataGroup')
    .attr('transform', 'translate(80,50)');

  group.selectAll('circle')
    .data(previousData)
    .enter()
    .append('circle')
    .attr('cx', function(d){ return x(+d.Year);})
    .attr('cy', function(d){ return y(+d.GasolinePrice);})
    .attr('r', 4)
    .style('fill', 'green')
    .style('opacity', 0.2);

  group.append('path')
    .datum(previousData)
    .attr('fill', 'none')
    .attr('stroke', 'green')
    .attr('stroke-width', 2)
    .attr('d', d3.line()
      .x(function(d){ return x(+d.Year);})
      .y(function(d){ return y(+d.GasolinePrice);}))
    .style('opacity', 0.2);

  group.selectAll('.current')
    .data(currentData)
    .enter()
    .append('circle')
    .attr('class', 'current')
    .attr('cx', function(d){ return x(+d.Year);})
    .attr('cy', function(d){ return y(+d.GasolinePrice);})
    .attr('r', 4)
    .style('fill', 'green')
    .style('opacity', 1);

  group.append('path')
    .datum(currentData)
    .attr('fill', 'none')
    .attr('stroke', 'green')
    .attr('stroke-width', 2)
    .attr('d', d3.line()
      .x(function(d){ return x(+d.Year);})
      .y(function(d){ return y(+d.GasolinePrice);}))

  // Tool tip logic
  group.selectAll(".hitarea")
   .data(currentData)
   .enter()
   .append("circle")
   .attr("class", "hitarea")
   .attr('cx', function(d){ return x(+d.Year);})
   .attr('cy', function(d){ return y(+d.GasolinePrice);})
   .attr('r', 6)
   .style('fill', 'transparent')
   .style("stroke", "transparent")
   .style('pointer-events', 'all')
   .on("mouseover", function(d){tooltip.style("opacity", 1)
      .style("left",(d3.event.pageX + 10)+"px")
      .style("top",(d3.event.pageY + 10)+"px")
      .html("Year: "+d.Year+"<br>Price: "+d.GasolinePrice);
      console.log("Hovered:", d.Year);
      d3.select(this)
      .style('fill', 'yellow')
      .style('stroke', 'black')
   })
   .on("mouseout", function() {
    tooltip.style("opacity", 0);
    d3.select(this)
      .style('fill', 'transparent')
      .style('stroke', 'transparent')
   });


  // Legend
  const legend = svg.append("g")
  .attr("class", "legend")
  .attr("transform", "translate(750,325)");

legend.append("circle")
  .attr("cx", 0)
  .attr("cy", 2)
  .attr("r", 6)
  .style("fill", "green");

legend.append("text")
  .attr("x", 15)
  .attr("y", 5)
  .text("Actual Gasoline Price")
  .style("font-family", "Arial")
  .style("font-size", "14px")
  .attr("alignment-baseline", "middle");

}

// Show next button
let currentIndex = 0;
const chunkSize = 10;

function showNext() {
  console.log(currentIndex);
  console.log(data.length);

  if (currentIndex >= data.length) 
  {
  return;
  }

  // use this so we can step through the chart
  const previousData = data.slice(0, currentIndex + chunkSize);
  const currentData = data.slice(currentIndex, currentIndex + chunkSize);

  const startYear = currentData[0].Year;
  const endYear   = currentData[currentData.length - 1].Year;

  // remove them so we only apply to the latest
  svg.selectAll(".dataGroup").remove();

  // Show the actual gas prices during that year
  ActualGasPrices(previousData,currentData);
  // Show the inflation related data
  InflationAdjusted(previousData,currentData);
  
  displayYearRange(startYear,endYear);


  currentIndex += chunkSize;

  if (currentIndex >= 74) 
  {
    d3.select("#showNext")
    .text("At the end of the visualization")
    .attr("disabled", true);
  }
}

function restartVisualization()
{
  // get rid of everything and restart
  svg.selectAll("*").remove();
  init();

  // reset index iterating over the data
  currentIndex = 0;

  // reset the button
  d3.select("#showNext")
    .text("Click To Show The Next 10 Years Of Gas Data")
    .attr("disabled", null); 
}

function displayYearRange(startYear,endYear)
{
  svg.selectAll(".yearLabel").remove();

  svg.append("text")
  .attr("class", "yearLabel")
  .attr("x", 740)
  .attr("y", 150)
  .style("font-family", "Arial")
  .style("font-size", "24px")
  .text(startYear + "-" + endYear);
}

// Add the annotations

</script>
</body>
</html>