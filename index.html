<html>
<script src='https://d3js.org/d3.v5.min.js'></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3-annotation/2.5.1/d3-annotation.min.js"></script>
<style> circle {fill: green; stroke: black;}
        .inflationCircle {fill: red; stroke: black;}
        [name="tooltip"] {
          position: absolute;
          opacity: 0;
          background-color: gainsboro;
          border: 1px solid #999;
          padding: 6px;
          font-size: 14px;
          pointer-events: none;
          transition: opacity 0.3s;
}</style>
<body onload='init()'>
<div style="position: absolute; top: 400px; left: 845px;">
  <button onclick="showNext()" id="showNext">Click To Begin</button>
</div>
<div style="position: absolute; top: 450px; left: 845px;">
  <button onclick="restartVisualization()">Click To Restart Visualization</button>
</div>
<div name="tooltip" opacity=0></div>
<div>
  <svg width="1100" height="1000"></svg>
</div>
<script>

let svg, data, x, y, tooltip;
let inflationDataVisible = false;

async function init() {
y = d3.scaleLinear().domain([0.01,4.8]).range([750,0]);
x = d3.scaleLinear().domain([1950,2025]).range([0,750]);

data = await d3.csv('https://seegerszach.github.io/GasPrices.csv');
svg = d3.select("svg");
tooltip = d3.select("div[name='tooltip']");

const t = d3.transition()
  .duration(7500)
  .ease(d3.easeLinear);

svg.append("g")
.attr("transform","translate("+80+","+50+")")
.call(d3.axisLeft(y).tickValues([0.1,0.5,1,3,4.5]).tickFormat(d3.format("$.2f")));

svg.append("g")
.attr("transform","translate("+80+","+800+")")
.call(d3.axisBottom(x).tickValues([1950,1960,1970,1980,1990,2000,2010,2020,2023]).tickFormat(d3.format("d")));

svg.append("text")
  .attr("transform", "translate(30,425) rotate(-90)")
  .text("Gasoline Price ($)");

svg.append("text")
  .attr("transform", "translate(455,840)")
  .text("Year");

svg.append("text")
  .attr("transform", "translate(380,20)")
  .style("font-size", "20px")
  .text("Gasoline Prices (1950-2023)");

svg.append("text")
  .attr("x", 840)
  .attr("y", 500)
  .style("font-family", "Arial")
  .style("font-size", "12px")
  .text("Note: Hover over active data for added details");
}

function InflationAdjusted(previousData,currentData) {

  const inflationLine = d3.line()
  .x(function(d){ return x(+d.Year);})
  .y(function(d){ return y(+d["GasolinePriceAdjustedforInflation(2023$/gallon)"]);});

  const group = svg.append('g')
    .attr('class', 'dataGroup')
    .attr('transform', 'translate(80,50)');

  group.selectAll('circle')
    .data(previousData)
    .enter()
    .append('circle')
    .attr('cx', function(d){ return x(+d.Year);})
    .attr('cy', function(d){ return y(+d["GasolinePriceAdjustedforInflation(2023$/gallon)"]);})
    .attr('r', 4)
    .style('fill', 'red')
    .style('opacity', 0.2);

  group.append('path')
    .datum(previousData)
    .attr('fill', 'none')
    .attr('stroke', 'red')
    .attr('stroke-width', 2)
    .attr('d', d3.line()
      .x(function(d){ return x(+d.Year);})
      .y(function(d){ return y(+d["GasolinePriceAdjustedforInflation(2023$/gallon)"]);}))
    .style('opacity', 0.2);

  group.selectAll('.current')
    .data(currentData)
    .enter()
    .append('circle')
    .attr('class', 'current')
    .attr('cx', function(d){ return x(+d.Year);})
    .attr('cy', function(d){ return y(+d["GasolinePriceAdjustedforInflation(2023$/gallon)"]);})
    .attr('r', 4)
    .style('fill', 'red')
    .style('opacity', 1)
    ;

  group.append('path')
    .datum(currentData)
    .attr('fill', 'none')
    .attr('stroke', 'red')
    .attr('stroke-width', 2)
    .attr('d', d3.line()
      .x(function(d){ return x(+d.Year);})
      .y(function(d){ return y(+d["GasolinePriceAdjustedforInflation(2023$/gallon)"]);}))

  // Tool tip/hit area logic
  group.selectAll(".hitarea")
   .data(currentData)
   .enter()
   .append("circle")
   .attr("class", "hitarea")
   .attr('cx', function(d){ return x(+d.Year);})
   .attr('cy', function(d){ return y(+d["GasolinePriceAdjustedforInflation(2023$/gallon)"]);})
   .attr('r', 6)
   .style('fill', 'transparent')
   .style("stroke", "transparent")
   .style('pointer-events', 'all')
   .on("mouseover", function(d,i){tooltip.style("opacity", 1)
      .style("left",(d3.event.pageX + 10)+"px")
      .style("top",(d3.event.pageY + 10)+"px")
      .html("Year: "+d.Year+"<br>Price: "+d["GasolinePriceAdjustedforInflation(2023$/gallon)"]);
      console.log("Hovered:", d.Year);
      d3.select(this)
      .style('fill', 'yellow')
      .style('stroke', 'black')
   })
   .on("mouseout", function() {
    tooltip.style("opacity", 0);
    d3.select(this)
    .style('fill', 'transparent')
    .style('stroke', 'transparent')
   });

   // Legend
   const legend = svg.append("g")
        .attr('class', 'inflationGroup')
        .attr("transform", "translate(845,300)");
        
        legend.append("circle")
        .attr("cx", 0)
        .attr("cy", 0)
        .attr("r", 6)
        .style("fill", "red");

        legend.append("text")
        .attr("x", 15)
        .attr("y", 2)
        .text("Inflation-Adjusted Price")
        .style("font-family", "Arial")
        .style("font-size", "14px")
        .attr("alignment-baseline", "middle");
}

function ActualGasPrices(previousData,currentData)
{
  const group = svg.append('g')
    .attr('class', 'dataGroup')
    .attr('transform', 'translate(80,50)');

  group.selectAll('circle')
    .data(previousData)
    .enter()
    .append('circle')
    .attr('cx', function(d){ return x(+d.Year);})
    .attr('cy', function(d){ return y(+d.GasolinePrice);})
    .attr('r', 4)
    .style('fill', 'green')
    .style('opacity', 0.2);

  group.append('path')
    .datum(previousData)
    .attr('fill', 'none')
    .attr('stroke', 'green')
    .attr('stroke-width', 2)
    .attr('d', d3.line()
      .x(function(d){ return x(+d.Year);})
      .y(function(d){ return y(+d.GasolinePrice);}))
    .style('opacity', 0.2);

  group.selectAll('.current')
    .data(currentData)
    .enter()
    .append('circle')
    .attr('class', 'current')
    .attr('cx', function(d){ return x(+d.Year);})
    .attr('cy', function(d){ return y(+d.GasolinePrice);})
    .attr('r', 4)
    .style('fill', 'green')
    .style('opacity', 1);

  group.append('path')
    .datum(currentData)
    .attr('fill', 'none')
    .attr('stroke', 'green')
    .attr('stroke-width', 2)
    .attr('d', d3.line()
      .x(function(d){ return x(+d.Year);})
      .y(function(d){ return y(+d.GasolinePrice);}))

  // Tool tip logic
  group.selectAll(".hitarea")
   .data(currentData)
   .enter()
   .append("circle")
   .attr("class", "hitarea")
   .attr('cx', function(d){ return x(+d.Year);})
   .attr('cy', function(d){ return y(+d.GasolinePrice);})
   .attr('r', 6)
   .style('fill', 'transparent')
   .style("stroke", "transparent")
   .style('pointer-events', 'all')
   .on("mouseover", function(d){tooltip.style("opacity", 1)
      .style("left",(d3.event.pageX + 10)+"px")
      .style("top",(d3.event.pageY + 10)+"px")
      .html("Year: "+d.Year+"<br>Price: "+d.GasolinePrice);
      console.log("Hovered:", d.Year);
      d3.select(this)
      .style('fill', 'yellow')
      .style('stroke', 'black')
   })
   .on("mouseout", function() {
    tooltip.style("opacity", 0);
    d3.select(this)
      .style('fill', 'transparent')
      .style('stroke', 'transparent')
   });


  // Legend
  const legend = svg.append("g")
  .attr("class", "legend")
  .attr("transform", "translate(845,325)");

legend.append("circle")
  .attr("cx", 0)
  .attr("cy", 2)
  .attr("r", 6)
  .style("fill", "green");

legend.append("text")
  .attr("x", 15)
  .attr("y", 5)
  .text("Actual Gasoline Price")
  .style("font-family", "Arial")
  .style("font-size", "14px")
  .attr("alignment-baseline", "middle");

}

// Show next button
let currentIndex = 0;
const chunkSize = 10;

function showNext() {
  console.log(currentIndex);
  console.log(data.length);

  // use this so we can step through the chart
  let previousData = data.slice(0, currentIndex + chunkSize);
  let currentData = data.slice(currentIndex, currentIndex + chunkSize);

  if (currentIndex >= data.length) 
  {
    previousData = data;
    currentData = data;
  }

  let startYear = currentData[0].Year;
  let endYear   = currentData[currentData.length - 1].Year;

  if (currentIndex >= data.length) 
  {
    startYear = "1950";
    endYear = "2023";
  }

  // remove them so we only apply to the latest
  svg.selectAll(".dataGroup").remove();

  // Show the actual gas prices during that year
  ActualGasPrices(previousData,currentData);
  // Show the inflation related data
  InflationAdjusted(previousData,currentData);
  
  displayYearRange(startYear,endYear);


  // add annotations
  addAnnotations(currentData);


  currentIndex += chunkSize;

  if (currentIndex > 0 && currentIndex < 80)
  {
    d3.select("#showNext")
    .text("Click To Show The Next Range Of Gas Data");
  }
  if (currentIndex == 80) 
  {
    d3.select("#showNext")
    .text("Click To Highlight All Data");

  }
  if (currentIndex > 80)
  {
    d3.select("#showNext")
    .style("opacity", 0)
    .attr("disabled", true);
  }
}

function restartVisualization()
{
  // get rid of everything and restart
  svg.selectAll("*").remove();
  init();

  // reset index iterating over the data
  currentIndex = 0;

  // reset the button
  d3.select("#showNext")
    .text("Click To Begin")
    .style("opacity", 1)
    .attr("disabled", null); 
}

function displayYearRange(startYear,endYear)
{
  svg.selectAll(".yearLabel").remove();

  svg.append("text")
  .attr("class", "yearLabel")
  .attr("x", 150)
  .attr("y", 150)
  .style("font-family", "Arial")
  .style("font-size", "24px")
  .text(startYear + "-" + endYear);
}

function displayAll()
{
  const group = svg.append('g')
    .attr('class', 'dataGroup')
    .attr('transform', 'translate(80,50)');

  group.selectAll('.redcircle')
    .data(data)
    .enter()
    .append('circle')
    .attr("class", "redcircle")
    .attr('cx', function(d){ return x(+d.Year);})
    .attr('cy', function(d){ return y(+d["GasolinePriceAdjustedforInflation(2023$/gallon)"]);})
    .attr('r', 4)
    .style('fill', 'red')
    .style('opacity', 1);

  group.append('path')
    .datum(data)
    .attr('fill', 'none')
    .attr('stroke', 'red')
    .attr('stroke-width', 2)
    .attr('d', d3.line()
      .x(function(d){ return x(+d.Year);})
      .y(function(d){ return y(+d["GasolinePriceAdjustedforInflation(2023$/gallon)"]);}))

  group.selectAll('.greencircle')
    .data(data)
    .enter()
    .append('circle')
    .attr("class", "greencircle")
    .attr('cx', function(d){ return x(+d.Year);})
    .attr('cy', function(d){ return y(+d.GasolinePrice);})
    .attr('r', 4)
    .style('fill', 'green')
    .style('opacity', 1);

  group.append('path')
    .datum(data)
    .attr('fill', 'none')
    .attr('stroke', 'green')
    .attr('stroke-width', 2)
    .attr('d', d3.line()
      .x(function(d){ return x(+d.Year);})
      .y(function(d){ return y(+d.GasolinePrice);}));

   // Tool tip logic
   group.selectAll(".hitarea")
   .data(data)
   .enter()
   .append("circle")
   .attr("class", "hitarea")
   .attr('cx', function(d){ return x(+d.Year);})
   .attr('cy', function(d){ return y(+d.GasolinePrice);})
   .attr('r', 6)
   .style('fill', 'transparent')
   .style("stroke", "transparent")
   .style('pointer-events', 'all')
   .on("mouseover", function(d){tooltip.style("opacity", 1)
      .style("left",(d3.event.pageX + 10)+"px")
      .style("top",(d3.event.pageY + 10)+"px")
      .html("Year: "+d.Year+"<br>Price: "+d.GasolinePrice);
      console.log("Hovered:", d.Year);
      d3.select(this)
      .style('fill', 'yellow')
      .style('stroke', 'black')
   })
   .on("mouseout", function() {
    tooltip.style("opacity", 0);
    d3.select(this)
      .style('fill', 'transparent')
      .style('stroke', 'transparent')
   });

   group.selectAll(".hitarea2")
   .data(data)
   .enter()
   .append("circle")
   .attr("class", "hitarea2")
   .attr('cx', function(d){ return x(+d.Year);})
   .attr('cy', function(d){ return y(+d["GasolinePriceAdjustedforInflation(2023$/gallon)"]);})
   .attr('r', 6)
   .style('fill', 'transparent')
   .style("stroke", "transparent")
   .style('pointer-events', 'all')
   .on("mouseover", function(d){tooltip.style("opacity", 1)
      .style("left",(d3.event.pageX + 10)+"px")
      .style("top",(d3.event.pageY + 10)+"px")
      .html("Year: "+d.Year+"<br>Price: "+d["GasolinePriceAdjustedforInflation(2023$/gallon)"]);
      console.log("Hovered:", d.Year);
      d3.select(this)
      .style('fill', 'yellow')
      .style('stroke', 'black')
   })
   .on("mouseout", function() {
    tooltip.style("opacity", 0);
    d3.select(this)
      .style('fill', 'transparent')
      .style('stroke', 'transparent')
   });

}
// Add the annotations
function addAnnotations(currentData) {
  const years = currentData.map(function(d) { return +d.Year; });

  const annotations = [];
  if (years.includes(1950)) {
    annotations.push({
      note: {
        label: "The US enters the Korean War, ending in an armistice in 1953",
        title: "Korean War Begins",
      },
      x: x(1950),
      y: y(+currentData[years.indexOf(1950)].GasolinePrice),
      dy: -20,
      dx: 30,
      type: d3.annotationCalloutElbow,
      connector: { end: "arrow" },
      color: "blue",
    });
  }
  if (years.includes(1963)) {
    annotations.push({
      note: {
        label: "President Kennedy is assassinated by Lee Harvey Oswald",
        title: "JFK Assassination",
      },
      x: x(1963),
      y: y(+currentData[years.indexOf(1963)]["GasolinePriceAdjustedforInflation(2023$/gallon)"]),
      dy: 20,
      dx: -1,
      type: d3.annotationCalloutElbow,
      connector: { end: "arrow" },
      color: "blue",
    });
  }
  if (years.includes(1973)) {
    annotations.push({
      note: {
        label: "Prices start rising rapidly due to the OPEC oil embargo. Peaking in 1981",
        title: "1973 Oil Crisis",
      },
      x: x(1973),
      y: y(+currentData[years.indexOf(1973)]["GasolinePriceAdjustedforInflation(2023$/gallon)"]),
      dy: 60,
      dx: -10,
      type: d3.annotationCalloutElbow,
      connector: { end: "arrow" },
      color: "blue",
    });
  }
  if (years.includes(1986)) {
    annotations.push({
      note: {
        label: "Significant surplus of crude oil caused by falling demand following the 1970s energy crisis causes prices to plummet",
        title: "1980s Oil Glut",
      },
      x: x(1986),
      y: y(+currentData[years.indexOf(1986)]["GasolinePriceAdjustedforInflation(2023$/gallon)"]),
      dy: 20,
      dx: -1,
      type: d3.annotationCallout,
      connector: { end: "arrow" },
      color: "blue",
    });
  }
  if (years.includes(1990)) {
    annotations.push({
      note: {
        label: "Iraq invades Kuwait, destabilizing the region",
        title: "Gulf War Begins",
      },
      x: x(1990),
      y: y(+currentData[years.indexOf(1990)].GasolinePrice),
      dy: -40,
      dx: -1,
      type: d3.annotationCalloutElbow,
      connector: { end: "arrow" },
      color: "blue",
    });
  }
  if (years.includes(2002)) {
    annotations.push({
      note: {
        label: "Following the 9/11 attacks, America invaded the Middle East leading to instability in the region",
        title: "Global War on Terror",
      },
      x: x(2002),
      y: y(+currentData[years.indexOf(2002)].GasolinePrice),
      dy: 10,
      dx: 10,
      type: d3.annotationCalloutElbow,
      connector: { end: "arrow" },
      color: "blue",
    });
  }
  if (years.includes(2008)) {
    annotations.push({
      note: {
        label: "Prices begin to fall soon after",
        title: "2008 Financial Crisis",
      },
      x: x(2008),
      y: y(+currentData[years.indexOf(2008)].GasolinePrice),
      dy: -50,
      dx: -60,
      type: d3.annotationCalloutElbow,
      connector: { end: "arrow" },
      color: "blue",
    });
  }
  if (years.includes(2012)) {
    annotations.push({
      note: {
        label: "Due to high demand and increasingly costly extraction methods",
        title: "Gas Prices Peak",
      },
      x: x(2012),
      y: y(+currentData[years.indexOf(2012)]["GasolinePriceAdjustedforInflation(2023$/gallon)"]),
      dy: 40,
      dx: -50,
      type: d3.annotationCalloutElbow,
      connector: { end: "arrow" },
      color: "blue",
    });
  }
    if (years.includes(2020)) {
    annotations.push({
      note: {
        label: "Global lockdowns in effect",
        title: "COVID-19 Pandemic",
      },
      x: x(2020),
      y: y(+currentData[years.indexOf(2020)].GasolinePrice),
      dy: 40,
      dx: -1,
      type: d3.annotationCalloutElbow,
      connector: { end: "arrow" },
      color: "blue",
    });
  }
    if (years.includes(2022)) {
    annotations.push({
      note: {
        label: "Production cuts from OPEC+ following the pandemic and the Russian invasion of Ukraine lead prices to spike",
        title: "Prices Rebound",
      },
      x: x(2022),
      y: y(+currentData[years.indexOf(2022)]["GasolinePriceAdjustedforInflation(2023$/gallon)"]),
      dy: -10,
      dx: 30,
      type: d3.annotationCalloutElbow,
      connector: { end: "arrow" },
      color: "blue",
    });
  }

  // Dim the existing annotations
  svg.selectAll(".annotation-group").style("opacity", 0.2);

  // Draw the annotations
  const makeAnnotations = d3.annotation()
    .annotations(annotations);

  svg.append("g")
    .attr("class", "annotation-group")
    .attr("transform", "translate(80,50)")
    .style("opacity", 1)
    .style("font-size", "11px")
    .style("font-family", "Arial")
    .call(makeAnnotations);
}
</script>
</body>
</html>